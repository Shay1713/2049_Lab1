/************** ECE2049 Lab1 CODE ******************/
/**************  25 March 2023   ******************/
/***************************************************/

#include <msp430.h>

/* Peripherals.c and .h are where the functions that implement
 * the LEDs and keypad, etc are. It is often useful to organize
 * your code by putting like functions together in files.
 * You include the header associated with that file(s)
 * into the main file of your project. */
#include "peripherals.h"
#include <stdio.h>
#include <stdlib.h>


// Declare globals here

int randomNum;
int numMax = 4;
int c = 0; // counter
int cChecker; // counter
int arrayIndex = 0; // the position in each array
int sequenceMax = 1; // max game length
char playerButton;
unsigned char patternArray[] = {}; // random led pattern
unsigned char userArray[] = {}; //saves user press button data
unsigned char currKey=0, dispSz = 3;
unsigned char dispThree[3];
unsigned char arrayLengthU = sizeof(userArray)/sizeof(userArray[0]); // for length of array
unsigned char arrayLengthP = sizeof(patternArray)/sizeof(patternArray[0]); // for length of array



// Function Prototypes
void swDelay(char numLoops);
void incPatternDisp (); // incrementing and displaying pattern
void clearingPatternUserArrays(); // if player loses, resetting arrays
void checkIfEqual();


// Main
void main(void)
{


    // Useful code starts here

    WDTCTL = WDTPW | WDTHOLD;    // Stop watchdog timer. Always need to stop this!!


    initLeds();
    configDisplay();
    configKeypad();

    // *** Intro Screen ***
    Graphics_clearDisplay(&g_sContext); // Clear the display
    Graphics_drawStringCentered(&g_sContext, "SIMON", AUTO_STRING_LENGTH, 48, 15, TRANSPARENT_TEXT);
    Graphics_drawStringCentered(&g_sContext, "Press *", AUTO_STRING_LENGTH, 48, 25, TRANSPARENT_TEXT);
    Graphics_drawStringCentered(&g_sContext, "to begin", AUTO_STRING_LENGTH, 48, 35, TRANSPARENT_TEXT);

    //Graphics_Rectangle box = {.xMin = 5, .xMax = 91, .yMin = 5, .yMax = 91 };
    //Graphics_drawRectangle(&g_sContext, &box);

    Graphics_flushBuffer(&g_sContext);
    dispThree[0] = ' ';
    dispThree[2] = ' ';


    // check console stuff here


        while (1)    // Forever loop
           {

               // Check if any keys have been pressed on the 3x4 keypad
               currKey = getKey();
               if (currKey == '*'){ // counting down
                   setLeds('3' - 0x30);
                   BuzzerOn();
                   Graphics_drawStringCentered(&g_sContext, "3", AUTO_STRING_LENGTH, 10, 55, TRANSPARENT_TEXT);
                   Graphics_flushBuffer(&g_sContext);
                   swDelay(2);
                   BuzzerOff();
                   swDelay(2);
                   setLeds('2' - 0x30);
                   BuzzerOn();
                   Graphics_drawStringCentered(&g_sContext, "2", AUTO_STRING_LENGTH, 30, 55, TRANSPARENT_TEXT);
                   Graphics_flushBuffer(&g_sContext);
                   swDelay(2);
                   BuzzerOff();
                   swDelay(2);
                   setLeds('1' - 0x30);
                   BuzzerOn();
                   Graphics_drawStringCentered(&g_sContext, "1", AUTO_STRING_LENGTH, 50, 55, TRANSPARENT_TEXT);
                   Graphics_flushBuffer(&g_sContext);
                   swDelay(2);
                   BuzzerOff();
                   swDelay(2);
                   setLeds('*'-0x30);
                   BuzzerOn();
                   Graphics_drawStringCentered(&g_sContext, "GO", AUTO_STRING_LENGTH, 70, 55, TRANSPARENT_TEXT);
                   Graphics_flushBuffer(&g_sContext);
                   swDelay(2);
                   BuzzerOff();
                   swDelay(2);
                   // calling first round to LCD screen
                   Graphics_clearDisplay(&g_sContext); // preparing to prompt the user
                   Graphics_flushBuffer(&g_sContext);
                   incPatternDisp(); // displaying pattern to user
                   Graphics_clearDisplay(&g_sContext); // clearing pattern numbers
                   Graphics_drawStringCentered(&g_sContext, "Repeat", AUTO_STRING_LENGTH, 48, 25, TRANSPARENT_TEXT); // instructing player
                   Graphics_flushBuffer(&g_sContext);


               }
               if (currKey == '1'){
                   setLeds(currKey - 0x30);
                   userArray[sequenceMax] = currKey;}
               if (currKey == '2'){
                  setLeds(currKey - 0x30);
                   userArray[sequenceMax] = currKey;}
               if (currKey == '3'){
                   setLeds(currKey - 0x30);
                   userArray[sequenceMax] = currKey;}
               if (currKey == '4'){
                   setLeds(currKey - 0x30);
                   userArray[sequenceMax] = currKey;}
               if (currKey == '9'){
                   setLeds(currKey - 0x30);
                   Graphics_drawStringCentered(&g_sContext, "Press *", AUTO_STRING_LENGTH, 48, 25, TRANSPARENT_TEXT); // restarting game
                   Graphics_drawStringCentered(&g_sContext, "to begin", AUTO_STRING_LENGTH, 48, 35, TRANSPARENT_TEXT);
                   Graphics_flushBuffer(&g_sContext);
                   sequenceMax = 1;
                   swDelay(4);
               }
               if (currKey == '0'){
                   setLeds('8' - 0x30);
                   Graphics_drawStringCentered(&g_sContext, "YOU LOSE", AUTO_STRING_LENGTH, 48, 50, TRANSPARENT_TEXT); // restarting game
                   Graphics_drawStringCentered(&g_sContext, "Press '9'", AUTO_STRING_LENGTH, 48, 60, TRANSPARENT_TEXT);
                   Graphics_flushBuffer(&g_sContext);
                   sequenceMax = 1;
                   swDelay(4);
               }
               if (currKey)
               {
                   dispThree[1] = currKey;
                   if ((currKey >= '5') && (currKey <= '8')){
                       setLeds(0);
                       printf("Button 5-8 pressed\n");}
                   if (currKey == '1'){
                       userArray[sequenceMax-1] = currKey;
                       Graphics_drawStringCentered(&g_sContext, dispThree, dispSz, 20, 55, OPAQUE_TEXT);
                       printf("Button 1 pressed\n");}
                   if (currKey == '2'){
                      userArray[sequenceMax-1] = currKey;
                      Graphics_drawStringCentered(&g_sContext, dispThree, dispSz, 40, 55, OPAQUE_TEXT);
                      printf("Button 2 pressed\n");}
                   if (currKey == '3'){
                       userArray[sequenceMax-1] = currKey;
                       Graphics_drawStringCentered(&g_sContext, dispThree, dispSz, 60, 55, OPAQUE_TEXT);
                       printf("Button 3 pressed\n");}
                   if (currKey == '4'){
                       userArray[sequenceMax-1] = currKey;
                       Graphics_drawStringCentered(&g_sContext, dispThree, dispSz, 80, 55, OPAQUE_TEXT);
                       printf("Button 4 pressed\n");}
                   if (currKey == '0'){
                      clearingPatternUserArrays();
                      printf("Button 0 pressed\n");
                      printf("sequenceMax pressed 0 is: %d\n", sequenceMax);}
                   if (currKey == '9'){
                      printf("Button 9 pressed\n");
                      printf("sequenceMax pressed 9 is: %d\n", sequenceMax);}

                   // Refresh the display so it shows the new data
                   Graphics_flushBuffer(&g_sContext);

                   BuzzerOn();
                   swDelay(2);
                   BuzzerOff();
                   setLeds(0);
                   Graphics_clearDisplay(&g_sContext); // Clear the display
                   Graphics_drawStringCentered(&g_sContext, "SIMON", AUTO_STRING_LENGTH, 48, 15, TRANSPARENT_TEXT);
                   Graphics_flushBuffer(&g_sContext);



                   //checkIfEqual(); // checking if arrays are equal
                
                  
               } 
                
               if (sequenceMax==40){ // setting game limit max rounds
                   Graphics_clearDisplay(&g_sContext); // Clear the display
                   Graphics_drawStringCentered(&g_sContext, "YOU WIN", AUTO_STRING_LENGTH, 48, 15, TRANSPARENT_TEXT);
                   Graphics_flushBuffer(&g_sContext);
                   swDelay(10);
                   sequenceMax=1; // resetting game rounds
               }
               

           }  // end while (1)

}


// functions start here

void swDelay(char numLoops)
{
    // This function is a software delay.

    volatile unsigned int i,j;  // volatile to prevent removal in optimization
                                // by compiler. Functionally this is useless code
    //int speed = 0;
    //speed = speed +100;
    for (j=0; j<numLoops; j++)
    {
        i = 50000 ;         // SW Delay
        while (i > 0)               // could also have used while (i)
           i--;
    }
}



void incPatternDisp () //generating pattern array
{   currKey = getKey();
    for (arrayIndex = 0; arrayIndex < sequenceMax; arrayIndex++){
        randomNum = (rand() % 4) +1;
        printf("IPD: in array index %d, sequenceMax %d, randomNum is %d\n", arrayIndex, sequenceMax, randomNum);
        if (randomNum == '1'){
            patternArray[arrayIndex] = '1';
            Graphics_drawStringCentered(&g_sContext, "1", AUTO_STRING_LENGTH, 10, 55, TRANSPARENT_TEXT);
            setLeds('1' - 0x30);
            Graphics_flushBuffer(&g_sContext); // fresh
            BuzzerOn();
            swDelay(1);
            BuzzerOff();
            setLeds(0);
            Graphics_clearDisplay(&g_sContext); // clear
        }
        if (randomNum == '2'){
            patternArray[arrayIndex] = '2';
            Graphics_drawStringCentered(&g_sContext, "2", AUTO_STRING_LENGTH, 30, 55, TRANSPARENT_TEXT);
            setLeds('2' - 0x30);
            Graphics_flushBuffer(&g_sContext); // refresh
            BuzzerOn();
            swDelay(1);
            BuzzerOff();
            setLeds(0);
            Graphics_clearDisplay(&g_sContext); // clear
        }
        if (randomNum == '3'){
            patternArray[arrayIndex] = '3';
            Graphics_drawStringCentered(&g_sContext, "3", AUTO_STRING_LENGTH, 50, 55, TRANSPARENT_TEXT);
            setLeds('3' - 0x30);
            Graphics_flushBuffer(&g_sContext); // refresh
            BuzzerOn();
            swDelay(1);
            BuzzerOff();
            setLeds(0);
            Graphics_clearDisplay(&g_sContext); // clear
        }
        if (randomNum == '4'){
            patternArray[arrayIndex] = '4';
            Graphics_drawStringCentered(&g_sContext, "4", AUTO_STRING_LENGTH, 70, 55, TRANSPARENT_TEXT);
            setLeds('4' - 0x30);
            Graphics_flushBuffer(&g_sContext); // refresh
            BuzzerOn();
            swDelay(1);
            BuzzerOff();
            setLeds(0);
            Graphics_clearDisplay(&g_sContext); // clear
        }
    }

}

void clearingPatternUserArrays() {
    printf("Before clearing arrays\n");
    for (arrayIndex = 0; arrayIndex < arrayLengthU; arrayIndex++){
        printf("userArray is %c\n", userArray[arrayIndex]);
        printf("patternArray is %c\n", patternArray[arrayIndex]);
    }
    for (arrayIndex = 0; arrayIndex < arrayLengthU; arrayIndex++){
        userArray[arrayIndex] = '\0'; // clearing user array
        patternArray[arrayIndex] = '\0'; // clearing random pattern array
    }
    printf("After clearing arrays\n");
    for (arrayIndex = 0; arrayIndex < arrayLengthU; arrayIndex++){
        printf("userArray is %c\n ", userArray[arrayIndex]);
        printf("patternArray is %c\n ", patternArray[arrayIndex]);
    }
    printf("arrays are cleared\n");
}


void checkIfEqual() {
      if ((arrayLengthU == arrayLengthP) && (arrayLengthU>0)) {
         for(arrayIndex = 0; arrayIndex<arrayLengthU; arrayIndex++) {
            if ((userArray[arrayIndex] == patternArray[arrayIndex])) {
                cChecker=1; 
            } else { 
                cChecker = 0;
                clearingPatternUserArrays();
                break; 
            }
         } 
         for (arrayIndex = 0; arrayIndex < arrayLengthU; arrayIndex++){
              userArray[arrayIndex] = '\0';
         }
         if (cChecker == 1) {
             sequenceMax++;
             cChecker = 2; // just setting to another value 
             currKey = getKey();
             currKey = '*';
         } else { 
             clearingPatternUserArrays();
             currKey = getKey();
             currKey = '9';
         }
      }
}






